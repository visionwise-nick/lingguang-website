# 文件权限方案对比

## 当前方案：loadHtmlString（推荐）

### 优点
1. **零权限**：不需要任何存储权限
2. **简单高效**：一行代码即可实现
3. **完美支持 localStorage**：WebView 自带支持
4. **跨平台兼容**：Android/iOS/macOS 全平台统一方案
5. **安全隔离**：每个应用运行在独立沙盒中
6. **无需审核说明**：应用商店审核无障碍
7. **零用户干扰**：不会弹出权限请求
8. **维护简单**：不受系统版本更新影响

### 实现方式
```dart
await _controller.loadHtmlString(
  widget.html,
  baseUrl: 'about:blank', // 支持localStorage
);
```

---

## 备选方案：file:// + 存储权限（不推荐）

### 需要的步骤

#### 1. AndroidManifest.xml 添加权限
```xml
<!-- Android 12 及以下 -->
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" 
    android:maxSdkVersion="32" />

<!-- Android 13+ 新的媒体权限 -->
<uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />
<uses-permission android:name="android.permission.READ_MEDIA_VIDEO" />
<uses-permission android:name="android.permission.READ_MEDIA_AUDIO" />
```

#### 2. pubspec.yaml 添加依赖
```yaml
dependencies:
  permission_handler: ^11.0.0
```

#### 3. 创建权限管理服务
```dart
// lib/services/permission_service.dart
import 'package:permission_handler/permission_handler.dart';

class PermissionService {
  static Future<bool> requestStoragePermission() async {
    if (Platform.isAndroid) {
      if (await Permission.storage.isGranted) {
        return true;
      }
      
      // Android 13+ 使用新的媒体权限
      if (Platform.version.contains('13') || 
          Platform.version.contains('14')) {
        final status = await Permission.photos.request();
        return status.isGranted;
      } else {
        final status = await Permission.storage.request();
        return status.isGranted;
      }
    }
    return true; // iOS 不需要此权限
  }
}
```

#### 4. 配置 WebView 允许文件访问
```dart
// 需要使用原生代码配置
// android/app/src/main/kotlin/MainActivity.kt
class MainActivity: FlutterActivity() {
    override fun configureFlutterEngine(flutterEngine: FlutterEngine) {
        super.configureFlutterEngine(flutterEngine)
        
        val webView = WebView(this)
        val settings = webView.settings
        settings.allowFileAccess = true
        settings.allowContentAccess = true
        settings.domStorageEnabled = true
        settings.databaseEnabled = true
        settings.allowFileAccessFromFileURLs = true
        settings.allowUniversalAccessFromFileURLs = true
    }
}
```

#### 5. 修改代码运行页面
```dart
Future<void> _initializeWebView() async {
  // 1. 请求权限
  final hasPermission = await PermissionService.requestStoragePermission();
  if (!hasPermission) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('需要存储权限'),
        content: Text('请授予存储权限以正常运行应用'),
        actions: [
          TextButton(
            onPressed: () => openAppSettings(),
            child: Text('去设置'),
          ),
        ],
      ),
    );
    return;
  }
  
  // 2. 创建文件
  final tempDir = await getTemporaryDirectory();
  _tempHtmlFile = File('${tempDir.path}/app.html');
  await _tempHtmlFile!.writeAsString(widget.html);
  
  // 3. 加载文件
  _controller = WebViewController()
    ..loadRequest(Uri.file(_tempHtmlFile!.path));
}
```

### 缺点
1. **复杂度高**：需要多处修改代码
2. **权限管理麻烦**：需要处理用户拒绝、永久拒绝等多种情况
3. **版本兼容问题**：Android 不同版本权限策略不同
4. **用户体验差**：权限弹窗会吓跑用户
5. **应用商店审核**：需要详细说明权限用途
6. **安全风险**：授予存储权限后应用可以访问所有文件
7. **iOS限制**：iOS的沙盒机制更严格，file://支持有限

---

## 场景选择建议

### 使用 loadHtmlString（当前方案）
✅ **适用场景**：
- 运行AI生成的Web应用（我们的核心功能）
- 需要localStorage支持
- 不需要访问设备文件系统
- 追求简单可靠的解决方案

### 使用 file:// + 权限
⚠️ **适用场景**：
- 必须访问设备相册/文件
- 需要导入用户本地资源
- 愿意承担复杂的权限管理

---

## 结论

**当前的 `loadHtmlString` 方案是最优选择**，因为：

1. 我们的核心功能是运行AI生成的Web应用
2. 不需要访问设备文件系统
3. localStorage 支持已经满足数据持久化需求
4. 零权限、零配置、零维护
5. 用户体验最佳（无权限弹窗）
6. 安全性最高（沙盒隔离）

除非有明确的文件访问需求（如图片上传、文件导入），否则不建议申请存储权限。

